rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ================= HELPER FUNCTIONS =================
    function signedIn() {
      return request.auth != null;
    }

    function userDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function role() {
      return userDoc().data.role;
    }

    function activeSchool() {
      return userDoc().data.activeSchoolId;
    }

    function isSchoolAdmin() {
      return signedIn() && role() == "school";
    }

    function isTeacher() {
      return signedIn() && role() == "teacher";
    }

    function isSub() {
      return signedIn() && role() == "sub";
    }

    function isParent() {
      return signedIn() && role() == "parent";
    }

    function isStaff() {
      return isSchoolAdmin() || isTeacher() || isSub() || role() == "librarian";
    }

    function isLibrarian() {
      return signedIn() && role() == "librarian";
    }

    function isParentOfStudent(studentId) {
      return isParent() && 
        request.auth.uid in get(/databases/$(database)/documents/students/$(studentId)).data.parentIds;
    }

    // Check if parent has children in this school
    function isParentAtSchool(schoolId) {
      return isParent() && activeSchool() == schoolId;
    }

    // Check if parent has a child in this class (via parentStudentLinks)
    function isParentOfStudentInClass(classId) {
      return isParent();
      // Note: Full verification happens at query time by filtering studentId
    }

    function isDistrictAdminForSchool(schoolId) {
      return signedIn() && role() == "district" &&
        userDoc().data.keys().hasAny(["districtId"]) &&
        userDoc().data.districtId != null &&
        userDoc().data.districtId != "" &&
        exists(/databases/$(database)/documents/districts/$(userDoc().data.districtId)) &&
        get(/databases/$(database)/documents/districts/$(userDoc().data.districtId)).data.ownerUid == request.auth.uid &&
        schoolId in get(/databases/$(database)/documents/districts/$(userDoc().data.districtId)).data.get("schoolIds", []);
    }

    function schoolHasActiveSubscription(schoolId) {
      let school = get(/databases/$(database)/documents/schools/$(schoolId)).data;
      return school.get("subscriptionActive", false) == true;
    }

    function isStudent() {
      return signedIn() && exists(/databases/$(database)/documents/students/$(request.auth.uid));
    }
    function studentSchoolId() {
      return get(/databases/$(database)/documents/students/$(request.auth.uid)).data.schoolId;
    }

    // ================= USERS =================
    match /users/{userId} {
      allow read, write: if signedIn() && request.auth.uid == userId;
    }

    match /schools/{schoolId} {
      // Any signed-in user can query schools (needed for school-code lookup)
      allow list: if signedIn();
      // Reading a specific school doc requires belonging to it or being signed in
      allow get: if signedIn();
      allow create: if signedIn();
      // Only school admin can update/delete their own school
      allow update, delete: if isSchoolAdmin() && activeSchool() == schoolId;

      // Students subcollection (if used within schools)
      match /students/{studentId} {
        allow read: if signedIn() && activeSchool() == schoolId;
        allow create: if signedIn() && activeSchool() == schoolId;
        allow update, delete: if signedIn() && activeSchool() == schoolId;
      }
    }

    // ================= DISTRICTS =================
    match /districts/{districtId} {
      allow read: if signedIn() && (
        isSchoolAdmin() || 
        resource.data.ownerUid == request.auth.uid
      );
      allow create: if signedIn();
      allow update, delete: if signedIn() && resource.data.ownerUid == request.auth.uid;
    }

    // ================= TEACHERS =================
    match /teachers/{teacherDocId} {
      allow read: if signedIn() && (
        resource.data.userId == request.auth.uid ||
        (isSchoolAdmin() && resource.data.schoolId == activeSchool()) ||
        ((isTeacher() || isSub()) && resource.data.schoolId == activeSchool() && schoolHasActiveSubscription(resource.data.schoolId)) ||
        (role() == "district" && isDistrictAdminForSchool(resource.data.schoolId))
      );

      allow create: if signedIn() && (
        (isTeacher() && request.resource.data.userId == request.auth.uid && request.resource.data.schoolId == null) ||
        (isSchoolAdmin() && request.resource.data.schoolId == activeSchool())
      );

      allow update: if signedIn() && (
        isSchoolAdmin() ||
        (isTeacher() && resource.data.userId == request.auth.uid)
      );

      allow delete: if isSchoolAdmin();
    }

    // ================= SUBS =================
    match /subs/{subDocId} {
      allow read: if signedIn() && (
        resource.data.userId == request.auth.uid ||
        (isSchoolAdmin() && resource.data.schoolId == activeSchool()) ||
        ((isTeacher() || isSub()) && resource.data.schoolId == activeSchool() && schoolHasActiveSubscription(resource.data.schoolId)) ||
        (role() == "district" && isDistrictAdminForSchool(resource.data.schoolId))
      );

      allow create: if signedIn() && (
        (isSub() && request.resource.data.userId == request.auth.uid && request.resource.data.schoolId == null) ||
        (isSchoolAdmin() && request.resource.data.schoolId == activeSchool())
      );

      allow update: if signedIn() && (
        isSchoolAdmin() ||
        (isSub() && resource.data.userId == request.auth.uid)
      );

      allow delete: if isSchoolAdmin();
    }

    // ================= PARENTS =================
    match /parents/{parentDocId} {
      allow read: if signedIn() && (
        resource.data.userId == request.auth.uid ||
        isSchoolAdmin()
      );

      allow create: if signedIn() && isParent() && request.resource.data.userId == request.auth.uid;

      allow update: if signedIn() && (
        resource.data.userId == request.auth.uid ||
        isSchoolAdmin()
      );

      allow delete: if isSchoolAdmin();
    }

    // ================= PARENT-STUDENT LINKS =================
    match /parentStudentLinks/{linkId} {
      allow read: if signedIn() && (
        resource.data.parentUserId == request.auth.uid ||
        resource.data.schoolId == activeSchool()
      );

      allow create: if signedIn() && (
        request.resource.data.parentUserId == request.auth.uid ||
        isSchoolAdmin()
      );

      allow update, delete: if signedIn() && (
        resource.data.parentUserId == request.auth.uid ||
        isSchoolAdmin()
      );
    }

    // ================= STUDENTS =================
    match /students/{studentId} {
      // Student self-read (no userDoc needed); school owner; staff/district with subscription; district admin; linked parent
      allow read: if signedIn() && (
        request.auth.uid == studentId ||
        (isSchoolAdmin() && resource.data.schoolId == activeSchool()) ||
        ((isTeacher() || isSub() || role() == "district") && resource.data.schoolId == activeSchool() && schoolHasActiveSubscription(resource.data.schoolId)) ||
        (role() == "district" && isDistrictAdminForSchool(resource.data.schoolId)) ||
        (isParent() && request.auth.uid in resource.data.parentIds && schoolHasActiveSubscription(resource.data.schoolId))
      );

      allow create: if signedIn() && 
        (isSchoolAdmin() || isTeacher()) && 
        request.resource.data.schoolId == activeSchool();

      // Schools, teachers, districts can update; parents can only update parentIds (via linking)
      allow update: if signedIn() && (
        (isSchoolAdmin() && resource.data.schoolId == activeSchool()) ||
        (isTeacher() && resource.data.schoolId == activeSchool() && schoolHasActiveSubscription(resource.data.schoolId)) ||
        (role() == "district" && isDistrictAdminForSchool(resource.data.schoolId)) ||
        (isParent() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['parentIds']))
      );

      allow delete: if isSchoolAdmin() && resource.data.schoolId == activeSchool();
    }

    // ================= CLASSES =================
    match /classes/{classId} {
      // School owner always; teachers/subs/parents need school to have active subscription
      allow read: if signedIn() && (
        (isSchoolAdmin() && resource.data.schoolId == activeSchool()) ||
        ((isTeacher() || isSub() || role() == "district") && resource.data.schoolId == activeSchool() && schoolHasActiveSubscription(resource.data.schoolId)) ||
        (isParent() && resource.data.schoolId == activeSchool() && schoolHasActiveSubscription(resource.data.schoolId))
      );

      allow create: if isSchoolAdmin() && request.resource.data.schoolId == activeSchool();

      allow update: if signedIn() && resource.data.schoolId == activeSchool() && (
        isSchoolAdmin() ||
        (isTeacher() && request.auth.uid in resource.data.teacherIds)
      );

      allow delete: if isSchoolAdmin();
    }

    // ================= CLASS ROSTERS =================
    match /class_rosters/{rosterId} {
      allow read: if signedIn() && (
        (isStudent() && resource.data.studentId == request.auth.uid) ||
        (isSchoolAdmin() && resource.data.schoolId == activeSchool()) ||
        ((isTeacher() || isSub() || role() == "district") && resource.data.schoolId == activeSchool() && schoolHasActiveSubscription(resource.data.schoolId)) ||
        (isParent() && isParentOfStudent(resource.data.studentId) && schoolHasActiveSubscription(resource.data.schoolId))
      );

      allow create, update, delete: if signedIn() && (
        isSchoolAdmin() ||
        (isTeacher() && resource.data.schoolId == activeSchool())
      );
    }

    // ================= EVENTS =================
    match /events/{eventId} {
      allow read: if signedIn() && (
        (isStudent() && resource.data.schoolId == studentSchoolId() && resource.data.get('teachersOnly', false) == false) ||
        (resource.data.schoolId == activeSchool() && (
        isSchoolAdmin() ||
        (schoolHasActiveSubscription(resource.data.schoolId) && (isStaff() || (isParent() && resource.data.get('teachersOnly', false) == false)))
        ))
      );
      allow create: if isSchoolAdmin() && request.resource.data.schoolId == activeSchool();
      allow update, delete: if isSchoolAdmin() && resource.data.schoolId == activeSchool();
    }

    // ================= ANNOUNCEMENTS =================
    match /announcements/{announcementId} {
      // School owner always; teachers/subs/parents need school subscription
      // Students can read all announcements at their school (no teachersOnly toggle on announcements)
      allow read: if signedIn() && (
        (isStudent() && resource.data.schoolId == studentSchoolId()) ||
        (resource.data.schoolId == activeSchool() && (isSchoolAdmin() ||
        (schoolHasActiveSubscription(resource.data.schoolId) && (isStaff() || isParent()))))
      );

      allow create: if isSchoolAdmin() && request.resource.data.schoolId == activeSchool();
      allow update, delete: if isSchoolAdmin() && resource.data.schoolId == activeSchool();
    }

    // ================= GRADE ASSIGNMENTS =================
    match /gradeAssignments/{assignmentId} {
      // School owner always; teachers/subs/parents need school subscription
      allow read: if signedIn() && (
        (isSchoolAdmin() && resource.data.schoolId == activeSchool()) ||
        (schoolHasActiveSubscription(resource.data.schoolId) && (isStaff() || role() == "district") && resource.data.schoolId == activeSchool()) ||
        (schoolHasActiveSubscription(resource.data.schoolId) && isParent() && resource.data.schoolId == activeSchool())
      );

      allow create: if signedIn() && 
        (isSchoolAdmin() || isTeacher()) && 
        request.resource.data.schoolId == activeSchool();

      allow update, delete: if signedIn() && (
        isSchoolAdmin() ||
        (isTeacher() && resource.data.schoolId == activeSchool())
      );
    }

    // ================= STUDENT GRADES =================
    match /studentGrades/{gradeId} {
      // School owner always; teachers/subs/parents need school subscription (schoolId from student)
      allow read: if signedIn() && (
        (isStudent() && resource.data.studentId == request.auth.uid) ||
        (isSchoolAdmin() && get(/databases/$(database)/documents/students/$(resource.data.studentId)).data.schoolId == activeSchool()) ||
        (schoolHasActiveSubscription(get(/databases/$(database)/documents/students/$(resource.data.studentId)).data.schoolId) && (isStaff() && get(/databases/$(database)/documents/students/$(resource.data.studentId)).data.schoolId == activeSchool())) ||
        (schoolHasActiveSubscription(get(/databases/$(database)/documents/students/$(resource.data.studentId)).data.schoolId) && isParent() && isParentOfStudent(resource.data.studentId))
      );

      allow create, update: if signedIn() && (
        isSchoolAdmin() ||
        (isTeacher() && activeSchool() != null)
      );

      allow delete: if isSchoolAdmin();
    }

    // ================= GRADE OVERRIDES =================
    match /gradeOverrides/{overrideId} {
      allow read: if signedIn() && (
        (isSchoolAdmin() && get(/databases/$(database)/documents/students/$(resource.data.studentId)).data.schoolId == activeSchool()) ||
        (schoolHasActiveSubscription(get(/databases/$(database)/documents/students/$(resource.data.studentId)).data.schoolId) && isStaff()) ||
        (schoolHasActiveSubscription(get(/databases/$(database)/documents/students/$(resource.data.studentId)).data.schoolId) && isParent() && isParentOfStudent(resource.data.studentId))
      );

      allow create, update: if signedIn() && (isSchoolAdmin() || isTeacher());
      allow delete: if isSchoolAdmin();
    }

    // ================= CLASS GRADE SETTINGS =================
    match /classGradeSettings/{classId} {
      allow read: if signedIn();
      allow create, update: if signedIn() && (isSchoolAdmin() || isTeacher());
      allow delete: if isSchoolAdmin();
    }

    // ================= SUB REQUESTS =================
    match /subRequests/{requestId} {
      // School owner always; teachers/subs need school subscription
      allow read: if signedIn() && resource.data.schoolId == activeSchool() && (
        isSchoolAdmin() ||
        (schoolHasActiveSubscription(resource.data.schoolId) && (isStaff() || role() == "district"))
      );

      allow create: if signedIn() && 
        (isSchoolAdmin() || isTeacher()) && 
        request.resource.data.schoolId == activeSchool();

      allow update: if signedIn() && resource.data.schoolId == activeSchool() && (
        isSchoolAdmin() ||
        isTeacher() ||
        isSub()
      );

      allow delete: if isSchoolAdmin();
    }

    // ================= TEACHER AVAILABILITY =================
    match /teacherAvailability/{availId} {
      // Only staff can read teacher availability (not parents)
      allow read: if signedIn() && isStaff() && resource.data.schoolId == activeSchool();

      allow create: if signedIn() && 
        (isTeacher() || isSchoolAdmin()) &&
        request.resource.data.schoolId == activeSchool();

      allow update: if signedIn() && (
        resource.data.teacherId == request.auth.uid ||
        isSchoolAdmin()
      );

      allow delete: if signedIn() && (
        resource.data.teacherId == request.auth.uid ||
        isSchoolAdmin()
      );
    }

    // ================= ATTENDANCE =================
    match /attendance/{attendanceId} {
      // School owner always; teachers/subs/parents need school subscription
      allow read: if signedIn() && (
        (isSchoolAdmin() && resource.data.schoolId == activeSchool()) ||
        (schoolHasActiveSubscription(resource.data.schoolId) && isStaff() && resource.data.schoolId == activeSchool()) ||
        (schoolHasActiveSubscription(resource.data.schoolId) && isParent() && isParentOfStudent(resource.data.studentId))
      );

      allow create, update: if signedIn() && (
        isSchoolAdmin() ||
        (isTeacher() && resource.data.schoolId == activeSchool())
      );

      allow delete: if isSchoolAdmin();
    }

    // ================= BELL SCHEDULES =================
    match /bellSchedules/{scheduleId} {
      allow read: if signedIn() && (
        (isStudent() && resource.data.schoolId == studentSchoolId()) ||
        (resource.data.schoolId == activeSchool() || isDistrictAdminForSchool(resource.data.schoolId))
      );
      // Only school and district admins can create/update/delete
      allow create: if (isSchoolAdmin() && request.resource.data.schoolId == activeSchool()) ||
        (role() == "district" && isDistrictAdminForSchool(request.resource.data.schoolId));
      allow update, delete: if (isSchoolAdmin() && resource.data.schoolId == activeSchool()) ||
        (role() == "district" && isDistrictAdminForSchool(resource.data.schoolId));
    }

    // ================= DOCUMENTS =================
    match /documents/{docId} {
      // Staff can read all documents, parents can only read non-teachersOnly documents
      allow read: if signedIn() && 
        resource.data.schoolId == activeSchool() &&
        (isStaff() || (isParent() && resource.data.get('teachersOnly', false) == false));

      allow create: if signedIn() && 
        (isSchoolAdmin() || isTeacher()) && 
        request.resource.data.schoolId == activeSchool();

      allow update, delete: if signedIn() && (
        isSchoolAdmin() ||
        (isTeacher() && resource.data.uploadedByUserId == request.auth.uid)
      );
    }

    // ================= CONVERSATIONS =================
    match /conversations/{conversationId} {
      allow read: if signedIn() && request.auth.uid in resource.data.participantIds;
      allow create: if signedIn() && request.auth.uid in request.resource.data.participantIds;
      allow update: if signedIn() && request.auth.uid in resource.data.participantIds;
      allow delete: if signedIn() && (
        request.auth.uid in resource.data.participantIds &&
        resource.data.createdByUserId == request.auth.uid
      );
    }

    // ================= MESSAGES =================
    match /messages/{messageId} {
      allow read: if signedIn() && (
        request.auth.uid in get(/databases/$(database)/documents/conversations/$(resource.data.conversationId)).data.participantIds
      );

      allow create: if signedIn() && request.resource.data.senderId == request.auth.uid;
      allow update, delete: if signedIn() && resource.data.senderId == request.auth.uid;
    }

    // ================= SUPPORT CLAIMS =================
    match /supportClaims/{claimId} {
      allow read: if signedIn() && resource.data.userId == request.auth.uid;
      allow create: if signedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if signedIn() && (
        resource.data.userId == request.auth.uid ||
        isSchoolAdmin()
      );
      allow delete: if false; // Support claims cannot be deleted
    }

    // ================= SUBSCRIPTIONS =================
    match /subscriptions/{subscriptionId} {
      allow read: if signedIn() && (
        resource.data.schoolId == activeSchool() ||
        resource.data.userId == request.auth.uid
      );
      allow create, update, delete: if false; // Managed by Cloud Functions only
    }

    // ================= PROMO CODES =================
    match /promoCodes/{codeId} {
      allow read: if signedIn();
      allow create, update, delete: if false; // Admin only via Firebase Console
    }

    // ================= PROMO CODE USAGE =================
    match /promoCodeUsage/{usageId} {
      allow read: if signedIn() && (
        resource.data.userId == request.auth.uid ||
        resource.data.schoolId == activeSchool()
      );
      allow create: if signedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }

    // ================= SUB REVIEWS (ranking) =================
    match /subReviews/{reviewId} {
      allow read: if signedIn() && (
        resource.data.schoolId == activeSchool() ||
        isDistrictAdminForSchool(resource.data.schoolId)
      );
      allow create: if signedIn() && isSchoolAdmin() && request.resource.data.schoolId == activeSchool();
      allow update, delete: if signedIn() && isSchoolAdmin() && resource.data.schoolId == activeSchool();
    }

    // ================= CONTACT FORM SUBMISSIONS =================
    match /contactFormSubmissions/{id} {
      allow read: if signedIn() && isSchoolAdmin();
      allow create: if false; // Cloud Function (admin) only
      allow update, delete: if false;
    }

    // ================= FUNDAY FRIDAY =================
    match /fundayFridayPicks/{pickId} {
      allow read: if signedIn();
      allow create: if signedIn();  // Admin runs from dashboard
      allow update, delete: if signedIn();
    }

    // ================= HOMEWORK =================
    match /homework/{homeworkId} {
      allow read: if signedIn() && (
        (isSchoolAdmin() && resource.data.schoolId == activeSchool()) ||
        (schoolHasActiveSubscription(resource.data.schoolId) && (isStaff() || role() == "district") && resource.data.schoolId == activeSchool()) ||
        (schoolHasActiveSubscription(resource.data.schoolId) && isParent() && resource.data.schoolId == activeSchool()) ||
        (isStudent() && resource.data.schoolId == studentSchoolId())
      );
      allow create: if signedIn() && (isSchoolAdmin() || isTeacher()) && request.resource.data.schoolId == activeSchool();
      allow update, delete: if signedIn() && (isSchoolAdmin() || isTeacher()) && resource.data.schoolId == activeSchool();
    }

    // ================= BEHAVIOR INCIDENTS =================
    match /behaviorIncidents/{incidentId} {
      allow read: if signedIn() && (
        (isSchoolAdmin() && resource.data.schoolId == activeSchool()) ||
        (schoolHasActiveSubscription(resource.data.schoolId) && isStaff() && resource.data.schoolId == activeSchool()) ||
        (schoolHasActiveSubscription(resource.data.schoolId) && isParent() && isParentOfStudent(resource.data.studentId))
      );
      allow create: if signedIn() && (isSchoolAdmin() || isTeacher()) && request.resource.data.schoolId == activeSchool();
      allow update, delete: if signedIn() && (isSchoolAdmin() || isTeacher()) && resource.data.schoolId == activeSchool();
    }

    // ================= GRADING SCALES =================
    match /gradingScales/{scaleId} {
      allow read: if signedIn() && resource.data.schoolId == activeSchool() && (
        isSchoolAdmin() || (schoolHasActiveSubscription(resource.data.schoolId) && (isStaff() || isParent()))
      );
      allow create, update, delete: if signedIn() && (isSchoolAdmin() || isTeacher()) && request.resource.data.schoolId == activeSchool();
    }

    // ================= BUS ROUTES =================
    match /busRoutes/{routeId} {
      allow read: if signedIn() && resource.data.schoolId == activeSchool() && (
        isSchoolAdmin() || (schoolHasActiveSubscription(resource.data.schoolId) && (isStaff() || isParent()))
      );
      allow create, update, delete: if signedIn() && (isSchoolAdmin() || isTeacher()) && request.resource.data.schoolId == activeSchool();
    }

    // ================= VIDEO MEETINGS =================
    match /videoMeetings/{meetingId} {
      allow read: if signedIn() && (
        resource.data.hostId == request.auth.uid ||
        request.auth.uid in resource.data.get("participantIds", [])
      );
      allow create: if signedIn() && (isSchoolAdmin() || isTeacher()) && request.resource.data.schoolId == activeSchool();
      allow update, delete: if signedIn() && (
        resource.data.hostId == request.auth.uid ||
        isSchoolAdmin()
      );
    }

    // ================= PORTFOLIO ITEMS =================
    match /portfolioItems/{itemId} {
      allow read: if signedIn() && (
        (isSchoolAdmin() && resource.data.schoolId == activeSchool()) ||
        (schoolHasActiveSubscription(resource.data.schoolId) && isStaff() && resource.data.schoolId == activeSchool()) ||
        (schoolHasActiveSubscription(resource.data.schoolId) && isParent() && isParentOfStudent(resource.data.studentId))
      );
      allow create: if signedIn() && (isSchoolAdmin() || isTeacher()) && request.resource.data.schoolId == activeSchool();
      allow update, delete: if signedIn() && (isSchoolAdmin() || isTeacher()) && resource.data.schoolId == activeSchool();
    }

    // ================= EMERGENCY ALERTS =================
    match /emergencyAlerts/{alertId} {
      allow read: if signedIn() && resource.data.schoolId == activeSchool();
      allow create: if signedIn() && isSchoolAdmin() && request.resource.data.schoolId == activeSchool();
      allow update, delete: if signedIn() && isSchoolAdmin() && resource.data.schoolId == activeSchool();
    }

    // ================= LUNCH MENUS =================
    match /lunchMenus/{menuId} {
      allow read: if signedIn() && resource.data.schoolId == activeSchool();
      allow create, update, delete: if signedIn() && (isSchoolAdmin() || isTeacher()) && request.resource.data.schoolId == activeSchool();
    }

    // ================= LESSON PLANS =================
    match /lessonPlans/{planId} {
      allow read: if signedIn() && (
        resource.data.teacherId == request.auth.uid ||
        (resource.data.schoolId == activeSchool() && resource.data.get("isShared", false) == true) ||
        (isSchoolAdmin() && resource.data.schoolId == activeSchool())
      );
      allow create: if signedIn() && (isSchoolAdmin() || isTeacher()) && request.resource.data.schoolId == activeSchool();
      allow update, delete: if signedIn() && (
        resource.data.teacherId == request.auth.uid ||
        isSchoolAdmin()
      );
    }

    // ================= CLASS ENROLLMENTS =================
    match /classEnrollments/{enrollmentId} {
      allow read: if signedIn() && (
        (isSchoolAdmin() && get(/databases/$(database)/documents/classes/$(resource.data.classId)).data.schoolId == activeSchool()) ||
        (schoolHasActiveSubscription(get(/databases/$(database)/documents/classes/$(resource.data.classId)).data.schoolId) && (isStaff() || isParent()))
      );
      allow create, update, delete: if signedIn() && (isSchoolAdmin() || isTeacher());
    }

    // ================= CLASS GRADES =================
    match /classGrades/{gradeDocId} {
      allow read: if signedIn() && (
        (isSchoolAdmin() && get(/databases/$(database)/documents/classes/$(resource.data.classId)).data.schoolId == activeSchool()) ||
        (schoolHasActiveSubscription(get(/databases/$(database)/documents/classes/$(resource.data.classId)).data.schoolId) && isStaff()) ||
        (schoolHasActiveSubscription(get(/databases/$(database)/documents/classes/$(resource.data.classId)).data.schoolId) && isParent() && isParentOfStudent(resource.data.studentId))
      );
      allow create, update, delete: if signedIn() && (isSchoolAdmin() || isTeacher());
    }

    match /gameLeaderboards/{entryId} {
      allow read: if signedIn();
      allow create: if signedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if signedIn() && resource.data.userId == request.auth.uid;
    }

    // ================= SCHOOL LIBRARIES =================
    match /schoolLibraries/{schoolId}/books/{bookId} {
      allow read: if signedIn();
      allow create, update, delete: if signedIn() && (
        (role() == "school" && activeSchool() == schoolId) ||
        (role() == "librarian" && activeSchool() == schoolId) ||
        (isTeacher() && activeSchool() == schoolId)
      );
    }

    // Library catalog (new management system)
    match /schoolLibraries/{schoolId}/catalog/{catalogId} {
      allow read: if signedIn();
      allow create, update, delete: if signedIn() && (
        (role() == "school" && activeSchool() == schoolId) ||
        (role() == "librarian" && activeSchool() == schoolId) ||
        (isTeacher() && activeSchool() == schoolId)
      );
    }

    // Library checkouts
    match /schoolLibraries/{schoolId}/checkouts/{checkoutId} {
      allow read: if signedIn() && activeSchool() == schoolId;
      allow create, update, delete: if signedIn() && (
        (role() == "school" && activeSchool() == schoolId) ||
        (role() == "librarian" && activeSchool() == schoolId) ||
        (isTeacher() && activeSchool() == schoolId)
      );
    }

    // ================= RECOMMENDED ACTIVITIES =================
    match /recommendedActivities/{activityId} {
      // Only staff can see recommended activities (not parents)
      allow read: if signedIn() && isStaff() && resource.data.schoolId == activeSchool();
      allow create: if signedIn() && (isSchoolAdmin() || isTeacher()) && request.resource.data.schoolId == activeSchool();
      allow update, delete: if signedIn() && (
        (isSchoolAdmin() && resource.data.schoolId == activeSchool()) ||
        (isTeacher() && resource.data.teacherId == request.auth.uid)
      );
    }
  }
}
